# ==========================================
# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼: Hugo ãƒ“ãƒ«ãƒ‰ & Cloudflare Pages ãƒ‡ãƒ—ãƒ­ã‚¤
# ==========================================
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã¾ã™:
# 1. PRä½œæˆ/æ›´æ–°æ™‚: ãƒ“ãƒ«ãƒ‰ã®ã¿å®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼‰
# 2. main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚: ãƒ“ãƒ«ãƒ‰ + Cloudflare Pages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
# ==========================================

name: Deploy to Cloudflare Pages

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  # main ãƒ–ãƒ©ãƒ³ãƒã¸ã® push æ™‚ã«å®Ÿè¡Œ
  push:
    branches: [main]
  # PR ä½œæˆ/æ›´æ–°æ™‚ã«å®Ÿè¡Œï¼ˆãƒ“ãƒ«ãƒ‰ç¢ºèªç”¨ï¼‰
  pull_request:

# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest  # å®Ÿè¡Œç’°å¢ƒ: Ubuntu æœ€æ–°ç‰ˆ

    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«è¨­å®š
    defaults:
      run:
        shell: bash

    steps:
      # ==========================================
      # Step 1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ==========================================
      # submodules: true â†’ Hugo ãƒ†ãƒ¼ãƒï¼ˆPaperModï¼‰ã‚’å–å¾—
      # fetch-depth: 0 â†’ å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆHugo ã® .GitInfo ç”¨ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      # ==========================================
      # Step 2: Hugo ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ==========================================
      # hugo-version: latest â†’ å¸¸ã«æœ€æ–°ç‰ˆã‚’ä½¿ç”¨
      # extended: true â†’ Sass/SCSS ã‚µãƒãƒ¼ãƒˆï¼ˆPaperMod ã§å¿…è¦ï¼‰
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      # ==========================================
      # Step 3: Hugo ãƒ“ãƒ«ãƒ‰
      # ==========================================
      # --minify â†’ HTML/CSS/JS ã‚’æœ€å°åŒ–ï¼ˆçˆ†é€ŸåŒ–ï¼‰
      # æˆæœç‰©ã¯ public/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å‡ºåŠ›
      - name: Build Hugo site
        run: hugo --minify

      # ==========================================
      # Step 4: Cloudflare Pages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
      # ==========================================
      # PR ã®å ´åˆã¯ãƒ“ãƒ«ãƒ‰ã®ã¿ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãªã„
      # main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
      - name: Deploy to Cloudflare Pages
        # æ¡ä»¶: push ã‚¤ãƒ™ãƒ³ãƒˆ ã‹ã¤ main ãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿å®Ÿè¡Œ
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: cloudflare/pages-action@v1
        with:
          # Cloudflare API ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆGitHub Secrets ã‹ã‚‰å–å¾—ï¼‰
          # âš ï¸ é‡è¦: çµ¶å¯¾ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ãªã„ï¼
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}

          # Cloudflare ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ IDï¼ˆGitHub Secrets ã‹ã‚‰å–å¾—ï¼‰
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          # Cloudflare Pages ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
          # âš ï¸ æ³¨æ„: Cloudflare Pages ã§ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã¨ä¸€è‡´ã•ã›ã‚‹
          projectName: my-blog  # å¾Œã§å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã«å¤‰æ›´ã—ã¦ãã ã•ã„

          # ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆHugo ã®ãƒ“ãƒ«ãƒ‰å‡ºåŠ›å…ˆï¼‰
          directory: public

          # Git ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å«ã‚ã‚‹
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # Step 5: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®å‡ºåŠ›
      # ==========================================
      - name: Output deployment info
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://my-blog.pages.dev"
